<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <title>VMS Pro Master V.11</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #f3f4f6; --card: #ffffff; --card-rgb: 255, 255, 255;
            --text: #111827; --muted: #6b7280; --border: #e5e7eb;
            --primary: #2563eb; --success: #10b981; --danger: #ef4444;
            --info: #0ea5e9; --overlay: rgba(17, 24, 39, 0.5);
            --btn-gray: #e5e7eb; --btn-gray-text: #374151;
        }
        [data-theme="dark"] {
            --bg: #020617; --card: #1e293b; --card-rgb: 30, 41, 59;
            --text: #f8fafc; --muted: #94a3b8; --border: #334155;
            --primary: #3b82f6; --success: #10b981; --danger: #f87171;
            --info: #38bdf8; --overlay: rgba(0, 0, 0, 0.7);
            --btn-gray: #334155; --btn-gray-text: #f1f5f9;
        }

        #pinScreen { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.5s; }
        .pin-box { background: var(--card); padding: 40px; border-radius: 35px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; max-width: 350px; width: 100%; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounceIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes bobbing { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-6px); } }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; transition: background 0.3s; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }

        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: var(--card); z-index: 9500; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid var(--border); padding: 30px 20px; box-sizing: border-box; }
        .sidebar.active { left: 0; box-shadow: 20px 0 50px rgba(0,0,0,0.2); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 9400; display: none; opacity: 0; transition: 0.3s; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        .nav-item { padding: 14px 18px; border-radius: 14px; margin-bottom: 8px; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 14px; color: var(--text); }
        .nav-item:hover { background: rgba(37, 99, 235, 0.1); color: var(--primary); }

        .sticky-header { position: sticky; top: 0; z-index: 1000; background: rgba(var(--card-rgb), 0.85); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); padding: 12px 20px; }
        .header-content { max-width: 1400px; margin: auto; display: flex; align-items: center; gap: 10px; }
        .btn-top { padding: 12px 6px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; color: white; font-size: 10px; flex: 1; text-transform: uppercase; }

        #searchDropdown { position: absolute; top: 70px; left: 0; width: 100%; padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); display: none; z-index: 999; animation: fadeUp 0.3s ease; box-sizing: border-box; }

        .container { max-width: 1400px; margin: 25px auto; padding: 0 15px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 18px; margin-bottom: 25px; }
        
        .card { background: var(--card); padding: 22px; border-radius: 28px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.03); animation: fadeUp 0.5s ease-out; transition: 0.3s; }
        .card h3 { font-size: 11px; margin: 0 0 18px 0; color: var(--muted); text-transform: uppercase; font-weight: 800; }
        
        input, select, textarea { width: 100%; background: var(--bg); border: 1.5px solid var(--border); color: var(--text); padding: 15px; border-radius: 14px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.2s; margin-bottom: 15px; }
        
        button.action { width: 100%; padding: 16px; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; color: white; transition: 0.2s; font-size: 14px; display: block; }
        .btn-p { background: var(--primary); } .btn-i { background: var(--info); } .btn-s { background: var(--success); } .btn-danger { background: var(--danger); }

        .search-box-main { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-panic { background: linear-gradient(45deg, var(--danger), #ff6b6b); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.3); }

        .table-box { background: var(--card); border-radius: 28px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.03); }
        table { width: 100%; border-collapse: collapse; min-width: 650px; }
        th { background: rgba(var(--card-rgb), 0.5); padding: 20px 15px; font-size: 11px; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 18px 15px; border-bottom: 1px solid var(--border); font-size: 14px; text-align: center; font-weight: 700; }
        .td-left { text-align: left !important; padding-left: 25px; } 

        .row-critical { background: rgba(239, 68, 68, 0.08) !important; border-left: 6px solid var(--danger); }
        .pointer-icon { display: inline-block; animation: bobbing 0.8s infinite; margin-left: 8px; font-size: 16px; vertical-align: middle; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--overlay); display:none; justify-content:center; align-items:flex-start; z-index:9600; backdrop-filter: blur(12px); padding: 20px; box-sizing: border-box; overflow-y: auto; }
        
        /* FIX MODAL TUMPANG TINDIH */
        #mProof { z-index: 9800 !important; }

        .modal { background: var(--card); padding: 35px; border-radius: 35px; width: 100%; max-width: 500px; border: 1px solid var(--border); animation: bounceIn 0.3s; margin-top: 50px; margin-bottom: 50px; position: relative; }
        .modal h2 { margin: 0 0 25px 0; font-size: 22px; text-align: center; font-weight: 800; color: var(--text); }
        .modal-footer { display: flex; gap: 10px; margin-top: 30px; }
        
        .btn-m { flex: 1; padding: 18px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; font-size: 14px; text-align: center; color: white; transition: 0.2s; }
        .btn-secondary { background: var(--btn-gray); color: var(--btn-gray-text); }

        .switch-container { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--bg); border-radius: 14px; margin-top: 20px; font-size: 13px; font-weight: 700; }
        .reset-label { font-size: 12px; font-weight: 800; color: var(--muted); display: block; margin-bottom: 8px; }

        .proof-table { width: 100%; border-collapse: collapse; margin-top: 15px; border-radius: 18px; overflow: hidden; }
        .proof-table th { background: var(--primary); color: white; padding: 12px; font-size: 10px; border: none; }
        .proof-table td { background: var(--bg); padding: 14px; font-size: 13px; border-bottom: 1px solid var(--border); font-weight: 700; }

        /* Fingerprint Icon */
.finger-container {
    margin: 40px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.finger-btn-pro {
    position: relative;
    width: 90px;
    height: 90px;
    background: rgba(37, 99, 235, 0.05);
    border: 2px solid rgba(37, 99, 235, 0.3);
    border-radius: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    cursor: pointer;
    overflow: hidden; /* Biar garis scan gak keluar box */
    transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.finger-btn-pro svg {
    width: 50px;
    height: 50px;
    z-index: 2;
    filter: drop-shadow(0 0 8px rgba(37, 99, 235, 0.5));
}

/* Animasi garis laser scan */
.scan-line {
    position: absolute;
    top: -100%;
    left: 0;
    width: 100%;
    height: 40%;
    background: linear-gradient(to bottom, transparent, rgba(37, 99, 235, 0.4), transparent);
    z-index: 1;
    animation: scanning 3s linear infinite;
}

@keyframes scanning {
    0% { top: -100%; }
    50% { top: 100%; }
    100% { top: -100%; }
}

.finger-btn-pro:hover {
    background: rgba(37, 99, 235, 0.15);
    border-color: var(--primary);
    transform: scale(1.05);
    box-shadow: 0 0 25px rgba(37, 99, 235, 0.2);
}

.tap-text {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 1.5px;
    color: var(--muted);
    text-transform: uppercase;
}    



</style>
</head>
<body>

<div id="pinScreen">
    <div class="pin-box">
        <img src="logo.png" style="width: 80px; margin-bottom: 20px; border-radius: 20px;">
        <h2>VMS Access</h2>
        <p style="color: var(--muted); font-size: 13px; margin-bottom: 25px;">Masukkan PIN atau Sidik Jari</p>
        <input type="password" id="pinInput" maxlength="4" inputmode="numeric" placeholder="****" style="text-align: center; font-size: 24px; letter-spacing: 15px;">
        
        <div class="finger-container">
    <button class="finger-btn-pro" onclick="tryBiometric()">
        <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M256,16C123.45,16,16,123.45,16,256S123.45,496,256,496s240-107.45,240-240S388.55,16,256,16ZM256,464C141.12,464,48,370.88,48,256S141.12,48,256,48s208,93.12,208,208S370.88,464,256,464Z" fill="currentColor" opacity="0.2"/>
            <path d="M256,80c-97.05,0-176,78.95-176,176s78.95,176,176,176,176-78.95,176-176S353.05,80,256,80Zm0,320c-79.4,0-144-64.6-144-144S176.6,112,256,112s144,64.6,144,144S335.4,400,256,400Z" fill="currentColor" opacity="0.3"/>
            <path d="M256,144c-61.75,0-112,50.25-112,112s50.25,112,112,112,112-50.25,112-112S317.75,144,256,144Zm0,192c-44.1,0-80-35.9-80-80s35.9-80,80-80,80,35.9,80,80S300.1,336,256,336Z" fill="currentColor" opacity="0.5"/>
            <path d="M256,208c-26.45,0-48,21.55-48,48s21.55,48,48,48,48-21.55,48-48S282.45,208,256,208Zm0,64c-8.85,0-16-7.15-16-16s7.15-16,16-16,16,7.15,16,16S264.85,272,256,272Z" fill="currentColor"/>
        </svg>
        <div class="scan-line"></div>
    </button>
    <span class="tap-text">TAP SENSOR JEMPOL</span>
</div>

        <button class="action btn-p" style="margin-top: 10px;" onclick="checkPIN()">BUKA DASHBOARD</button>
    </div>
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:35px;">
        <img src="logo.png" style="width: 80px; height: 80px; border-radius: 20px; margin-bottom: 10px; object-fit: cover; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
        <h2 style="margin:0; font-size:22px; font-weight:800; color:var(--primary);">VMS MASTER</h2>
    </div>
    
    <div class="nav-item" onclick="toggleSidebar()">üè† Dashboard</div>
    <div class="nav-item" onclick="openHistory(); toggleSidebar()">üìú Riwayat & Bukti</div>
    <div class="nav-item" onclick="openModal('mAnalytics'); loadChart(); toggleSidebar()">üìà Grafik Analis</div>
    <div class="nav-item" onclick="openModal('mAdd'); toggleSidebar()">‚ûï Tambah Voucher</div>
    <div class="nav-item" onclick="openModal('mReset'); toggleSidebar()">‚öôÔ∏è Reset / Hapus Data</div>
    <div class="nav-item" onclick="window.open('https://docs.google.com/spreadsheets/d/1B5tbG7DmaWxYpnYkLcmuNA0cUGZj9sE0q1Qy4xgWNFY/edit', '_blank')">üìë Buka Laporan Print</div>

    <button onclick="toggleSidebar()" style="width:100%; margin-top:30px; padding:12px; border:none; background:var(--bg); border-radius:12px; color:var(--muted); font-weight:800; cursor:pointer;">TUTUP MENU</button>
</div>

<div class="sticky-header">
    <div class="header-content">
        <button onclick="toggleSidebar()" style="background:none; border:none; font-size:28px; color:var(--text); cursor:pointer; padding:0 8px;">‚ò∞</button>
        <button onclick="toggleNavSearch()" style="background:none; border:none; font-size:24px; cursor:pointer;">üîç</button>
        
        <div class="main-actions" style="display:flex; gap:8px; flex:1; justify-content: flex-end;">
            <button class="btn-top" style="background:var(--primary)" onclick="startSequentialUpdate()">üöÄ UPDATE</button>
            <button class="btn-top" style="background:#25D366" onclick="openLaporan()">üìä LAPORAN</button>
            <button class="btn-top" style="background:var(--danger)" onclick="saveDailySnapshot()">üíæ TUTUP</button>
        </div>
        <button onclick="toggleTheme()" id="themeIcon" style="background:none; border:none; font-size:24px; cursor:pointer; margin-left:5px;">üåû</button>
    </div>

    <div id="searchDropdown">
        <input type="text" id="headerSearchInput" placeholder="Cari voucher..." onkeyup="filterData('headerSearchInput')">
    </div>
</div>

<div class="container">
    <button class="btn-panic" onclick="panicRestock()">
        <span>üöÄ</span> PANIC RESTOCK (STOK KRITIS)
    </button>

    <div class="search-box-main">
        <div style="flex:2">
            <input type="text" id="mainSearchInput" placeholder="Cari nama voucher..." onkeyup="filterData('mainSearchInput')">
        </div>
        <div style="flex:1">
            <select id="categoryFilter" onchange="filterData('mainSearchInput')">
                <option value="all">Semua</option>
                <option value="kritis">Stok Kritis</option>
                <option value="aman">Stok Aman</option>
            </select>
        </div>
    </div>

<div class="grid">
    <div class="card">
        <h3>üöö Pindahkan Stock Ke Etalase</h3>
        <div style="display:flex; gap:10px; margin-bottom:5px;">
            <div style="flex:1.5">
                <label style="font-size:10px; font-weight:800;">PILIH VOUCHER</label>
                <select id="selP" style="margin-bottom: 15px;">
                    <option value="">-- Pilih Voucher --</option>
                </select>
            </div>
            <div style="flex:1">
                <label style="font-size:10px; font-weight:800;">QTY</label>
                <input type="number" id="qtyP" inputmode="numeric" placeholder="0">
            </div>
        </div>
        <button class="action btn-i" onclick="doMove()">Pindahkan ke Etalase</button>
    </div>

    <div class="card">
        <h3>üì¶ Restock Kamar</h3>
        <div style="display:flex; gap:10px; margin-bottom:5px;">
            <div style="flex:1.5">
                <label style="font-size:10px; font-weight:800;">PILIH VOUCHER</label>
                <select id="selR" style="margin-bottom: 15px;">
                    <option value="">-- Pilih Voucher --</option>
                </select>
            </div>
            <div style="flex:1">
                <label style="font-size:10px; font-weight:800;">QTY</label>
                <input type="number" id="qtyR" inputmode="numeric" placeholder="0">
            </div>
        </div>
        <button class="action btn-s" onclick="doRestock()">Simpan ke Kamar</button>
    </div>
</div>

<div class="table-box">
    <table>
        <thead>
            <tr>
                <th class="td-left">Voucher (Produk)</th>
                <th>Kmr</th>
                <th>Etl</th>
                <th>Laku</th>
            </tr>
        </thead>
        <tbody id="vTableBody"></tbody>
    </table>
</div>

<div class="modal-overlay" id="mReset"><div class="modal">
    <h2>Reset / Hapus Data</h2>
    <label class="reset-label">Mode</label>
    <select id="rMode" onchange="toggleResetUI()">
        <option value="single">Satu Baris (ID)</option>
        <option value="all">Semua Baris</option>
    </select>
    <div id="resetIdGroup">
        <label class="reset-label">ID Voucher</label>
        <input type="number" id="rID" inputmode="numeric" placeholder="Masukkan ID">
    </div>
    <label class="reset-label">Tindakan</label>
    <select id="rCol">
        <option value="1">1. Reset Laku Saja</option>
        <option value="2">2. Reset Etalase Saja</option>
        <option value="3">3. Reset Kamar Saja</option>
        <option value="4">4. Reset Laku & Etalase</option>
        <option value="5">5. Hapus Voucher Permanen</option>
    </select>
    <div class="modal-footer">
        <button class="btn-m btn-secondary" onclick="closeModal('mReset')">Batal</button>
        <button class="btn-m btn-danger" style="color:white" onclick="confirmReset()">Eksekusi</button>
    </div>
</div></div>

<div class="modal-overlay" id="mProof"><div class="modal" style="max-width:550px">
    <h2 id="proofTitle" style="font-size:20px; text-align:center;">Rincian Transaksi</h2>
    <div id="proofBody" style="max-height:400px; overflow-y:auto; padding-right:5px;"></div>
    <button class="btn-m btn-p" style="width:100%; margin-top:20px" onclick="closeModal('mProof')">TUTUP</button>
</div></div>

<div class="modal-overlay" id="mHistory"><div class="modal" style="max-width:650px">
    <h2>Riwayat Laporan</h2>
    <div id="histContent" style="max-height:400px; overflow-y:auto;"></div>
    <div class="modal-footer" style="flex-direction: column; gap: 10px;">
        <button class="btn-m btn-danger" style="width: 100%;" onclick="clearAllHistory()">üî• BANTAI SEMUA RIWAYAT</button>
        <button class="btn-m btn-p" style="width:100%;" onclick="closeModal('mHistory')">Tutup</button>
    </div>
</div></div>

<div class="modal-overlay" id="mSequential"><div class="modal">
    <div style="text-align:center"><span id="seqProgress" style="font-size:10px; font-weight:800; color:var(--primary);">ITEM 1 DARI 10</span><h2 id="seqName" style="margin:10px 0 30px 0; font-size:28px;">NAMA VOUCHER</h2></div>
    <label class="reset-label">SISA DI ETALASE:</label>
    <input type="number" id="seqSisaInput" inputmode="numeric">
    <div class="modal-footer">
        <button class="btn-m btn-secondary" onclick="prevSeq()">BACK</button>
        <button class="btn-m" style="background:var(--success)" onclick="saveCurrentSeq()">SIMPAN</button>
        <button class="btn-m btn-secondary" onclick="nextSeq()">NEXT</button>
    </div>
    <button onclick="closeModal('mSequential')" style="width:100%; margin-top:30px; background:none; border:none; color:var(--muted); font-size:12px; font-weight:700;">Berhenti</button>
</div></div>

<div class="modal-overlay" id="mAdd"><div class="modal">
    <h2>Voucher Baru</h2>
    <input type="text" id="aL" placeholder="Nama Lengkap">
    <input type="text" id="aW" placeholder="Nama WA">
    <input type="number" id="aH" placeholder="Harga Jual">
    <div class="modal-footer">
        <button class="btn-m btn-secondary" onclick="closeModal('mAdd')">Batal</button>
        <button class="btn-m btn-p" onclick="saveNew()">Simpan</button>
    </div>
</div></div>

<div class="modal-overlay" id="mAnalytics"><div class="modal" style="max-width: 800px;"><h2>üìä Performa Warung</h2><div style="background:var(--bg); padding:15px; border-radius:20px;"><canvas id="fullChart" style="width:100%; height:400px;"></canvas></div><button class="btn-m btn-p" style="width:100%; margin-top:25px;" onclick="closeModal('mAnalytics')">TUTUP ANALIS</button></div></div>
<div class="modal-overlay" id="mReport"><div class="modal"><h2>Laporan WA</h2><p id="tSis" style="font-weight:800; color:var(--primary); text-align:center; font-size:22px; margin-bottom:20px;"></p><label class="reset-label">Uang Fisik:</label><input type="number" id="iF" inputmode="numeric"><div class="modal-footer"><button class="btn-m btn-secondary" onclick="closeModal('mReport')">Batal</button><button class="btn-m btn-p" onclick="genFinal()">Generate</button></div></div></div>
<div class="modal-overlay" id="mView"><div class="modal"><h2>Salin Laporan</h2><textarea id="repRes" readonly style="width:100%; height:300px; padding:15px; font-size:13px;"></textarea><button class="btn-m btn-p" style="width:100%; margin-top:15px;" onclick="copyClose()">Copy & Tutup</button></div></div>




<script>
    const SB_URL = "https://cphgjbsdzslyyaduherc.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwaGdqYnNkenNseXlhZHVoZXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDg4MDMsImV4cCI6MjA4NTg4NDgwM30.bzoog6sHewP_VpqCg7oXS33HyeB_OYEExB5cbsAnQX8";
    const client = supabase.createClient(SB_URL, SB_KEY);

    let gTotal = 0; let gItem = 0; let seqData = []; let seqIdx = 0; let gBreakdown = "";
    let myChart = null;

    // --- BIOMETRIC AUTH ---
// --- HELPER BIAR ID GAK ILANG (Base64 Converter) ---
const bufferEncode = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
const bufferDecode = (str) => Uint8Array.from(atob(str.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));

async function tryBiometric() {
    if (!window.PublicKeyCredential) return alert("HP lu gak support, cuy!");

    const savedId = localStorage.getItem('vms_finger_id');

    // Kalau belum pernah daftar, paksa daftar dulu
    if (!savedId) {
        if (confirm("Sidik jari belum terdaftar di sistem. Daftar sekarang?")) {
            await registerBiometric();
        }
        return;
    }

    try {
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);

        const auth = await navigator.credentials.get({
            publicKey: {
                challenge: challenge,
                rpId: window.location.hostname,
                userVerification: "required",
                // INI KUNCINYA: Ngasih tau browser ID mana yang mau dipake
                allowCredentials: [{
                    id: bufferDecode(savedId),
                    type: 'public-key'
                }]
            }
        });

        if (auth) {
            document.getElementById('pinScreen').style.display = "none";
            refresh();
            console.log("Login Berhasil, Boss!");
        }
    } catch (err) {
        console.error(err);
        // Kalau error karena ID gak cocok, hapus aja biar bisa daftar ulang
        if(err.name === "NotAllowedError") {
            alert("Sidik jari gak dikenal atau dibatalkan!");
        } else {
            localStorage.removeItem('vms_finger_id');
            alert("Kunci bermasalah, silakan daftar ulang!");
        }
    }
}

async function registerBiometric() {
    try {
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);
        const userID = new Uint8Array(16);
        window.crypto.getRandomValues(userID);

        const credential = await navigator.credentials.create({
            publicKey: {
                challenge: challenge,
                rp: { name: "VMS Pro Master", id: window.location.hostname },
                user: {
                    id: userID,
                    name: "Admin-VMS",
                    displayName: "Admin VMS"
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                authenticatorSelection: { authenticatorAttachment: "platform" },
                timeout: 60000
            }
        });

        if (credential) {
            // Simpan ID dalam bentuk string biar gak ilang pas refresh
            const idString = bufferEncode(credential.rawId);
            localStorage.setItem('vms_finger_id', idString);
            alert("MANTAP! Jari lu udah terdaftar. Sekarang klik lagi buat masuk!");
        }
    } catch (err) {
        console.error(err);
        alert("Gagal daftar. Pastikan HP lu pake kunci layar (PIN/Pola)!");
    }
}

    function toggleResetUI() {
        const mode = document.getElementById('rMode').value;
        document.getElementById('resetIdGroup').style.display = (mode === 'all') ? 'none' : 'block';
    }

    async function confirmReset() {
        const mode = document.getElementById('rMode').value;
        const action = document.getElementById('rCol').value;
        const id = document.getElementById('rID').value;
        if(mode === 'single' && !id) return alert("ID-nya mana cuy?");
        if(!confirm("Yakin mau eksekusi? Gak bisa dibatalin loh!")) return;
        let res;
        const table = client.from('vouchers');
        let payload = {};
        if(action === "1") payload = { terjual: 0 };
        else if(action === "2") payload = { stok_etalase: 0 };
        else if(action === "3") payload = { stok_kamar: 0 };
        else if(action === "4") payload = { terjual: 0, stok_etalase: 0 };
        try {
            if(action === "5") {
                if(mode === 'single') res = await table.delete().eq('id', id);
                else res = await table.delete().gt('id', 0);
            } else {
                if(mode === 'single') res = await table.update(payload).eq('id', id);
                else res = await table.update(payload).gt('id', 0);
            }
            if(res.error) throw res.error;
            alert("Berhasil!"); closeModal('mReset'); refresh();
        } catch(e) { alert("Gagal eksekusi cuy!"); console.error(e); }
    }

    async function showProof(tgl) {
        const { data } = await client.from('laporan_harian').select('detail_terjual').eq('tanggal', tgl).single();
        if(data && data.detail_terjual) {
            let html = `<table class="proof-table"><thead><tr><th>PRODUK</th><th>QTY</th><th>SUB</th></tr></thead><tbody>`;
            data.detail_terjual.forEach(v => {
                html += `<tr><td>${v.nama_wa}</td><td style="text-align:center">${v.terjual}</td><td style="text-align:right">Rp${((v.terjual*v.harga_jual)/1000).toFixed(0)}k</td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('proofTitle').innerText = `Rincian ${tgl}`;
            document.getElementById('proofBody').innerHTML = html;
            openModal('mProof');
        }
    }

    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    }
    function toggleNavSearch() {
        const d = document.getElementById('searchDropdown');
        d.style.display = (d.style.display === 'block') ? 'none' : 'block';
        if(d.style.display === 'block') document.getElementById('headerSearchInput').focus();
    }

    function checkPIN() { if(document.getElementById('pinInput').value === "1234") { document.getElementById('pinScreen').style.display = "none"; refresh(); } else { alert("PIN SALAH!"); } }
    
async function refresh() {
    const { data } = await client.from('vouchers').select('*').order('id', { ascending: true });
    const b = document.getElementById('vTableBody'); 
    b.innerHTML = '';
    
    // Siapkan dropdown (tetap ada buat input stok)
    const selP = document.getElementById('selP');
    const selR = document.getElementById('selR');
    selP.innerHTML = '<option value="">-- Pilih Voucher --</option>';
    selR.innerHTML = '<option value="">-- Pilih Voucher --</option>';

    gTotal = 0; gItem = 0;
    
    if (data) {
        data.forEach((v) => {
            // Logika Baris Merah: Muncul kalau stok ETALASE 0
            const isCrit = v.stok_etalase <= 0 && !v.is_ignored;
            const row = document.createElement('tr');
            if (isCrit) row.classList.add('row-critical');

            const stockUI = isCrit ? `${v.stok_etalase} <span class="pointer-icon">üëà</span>` : v.stok_etalase;

            // Render Tabel TANPA kolom ID dan AKSI
            row.innerHTML = `
                <td class="td-left">${v.nama_lengkap}</td>
                <td>${v.stok_kamar}</td>
                <td>${stockUI}</td>
                <td><span style="color:var(--danger);">${v.terjual}</span></td>
            `;
            b.appendChild(row);
            
            // Isi Dropdown buat input stok (biar gak ribet ngetik ID)
            const opt = `<option value="${v.id}">${v.nama_wa}</option>`;
            selP.innerHTML += opt;
            selR.innerHTML += opt;

            gTotal += (v.terjual * v.harga_jual); 
            gItem += v.terjual;
        });
    }
}

    function filterData(inputId) {
        const query = document.getElementById(inputId).value.toLowerCase();
        const cat = document.getElementById('categoryFilter').value;
        const rows = document.querySelectorAll('#vTableBody tr');
        rows.forEach(row => {
            const name = row.cells[1].innerText.toLowerCase();
            const isCrit = row.classList.contains('row-critical');
            const matchQ = name.includes(query);
            let matchC = (cat === 'all') || (cat === 'kritis' ? isCrit : !isCrit);
            row.style.display = (matchQ && matchC) ? '' : 'none';
        });
    }

    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    
    async function startSequentialUpdate() { const { data } = await client.from('vouchers').select('*').order('id', { ascending: true }); if (data) { seqData = data; seqIdx = 0; renderSeq(); openModal('mSequential'); } }
    function renderSeq() { const v = seqData[seqIdx]; document.getElementById('seqProgress').innerText = `ITEM ${seqIdx + 1} DARI ${seqData.length}`; document.getElementById('seqName').innerText = v.nama_wa; document.getElementById('seqSisaInput').value = v.stok_etalase; document.getElementById('seqSisaInput').focus(); }
    async function saveCurrentSeq() { const v = seqData[seqIdx]; const s = parseInt(document.getElementById('seqSisaInput').value); if(!isNaN(s)) { await client.from('vouchers').update({ stok_etalase: s, terjual: v.terjual + (v.stok_etalase - s), is_ignored: false }).eq('id', v.id); if(seqIdx < seqData.length - 1) nextSeq(); else { closeModal('mSequential'); refresh(); } } }
    function nextSeq() { if(seqIdx < seqData.length - 1) { seqIdx++; renderSeq(); } }
    function prevSeq() { if(seqIdx > 0) { seqIdx--; renderSeq(); } }
    
    async function openLaporan() { const { data } = await client.from('vouchers').select('*').order('id', { ascending: true }); gBreakdown = ""; data.forEach(v => { gBreakdown += ` ${v.nama_wa} = ${v.stok_etalase}\n`; }); document.getElementById('tSis').innerText = `Sistem: Rp${gTotal.toLocaleString()}`; openModal('mReport'); }
    function genFinal() { const f = parseInt(document.getElementById('iF').value) || 0; const n = new Date(); const m = ['januari','februari','maret','april','mei','juni','juli','agustus','september','oktober','november','desember']; const ts = `*${n.getDate()}/${m[n.getMonth()]}/${String(n.getFullYear()).slice(-2)} ${n.getHours()}:${n.getMinutes().toString().padStart(2, '0')}*`; document.getElementById('repRes').value = `${ts}\n\n${gBreakdown}\n------------------\nüí∞ Target: Rp${gTotal.toLocaleString()}\nüíµ Uang Fisik: Rp${f.toLocaleString()}\nüö® Selisih: Rp${(f-gTotal).toLocaleString()}`; closeModal('mReport'); openModal('mView'); }

    async function saveDailySnapshot() {
        if(!confirm("Yakin mau tutup hari ini? Semua data 'Laku' akan di-reset.")) return;
        try {
            const { data: s, error: errFetch } = await client.from('vouchers').select('nama_wa, terjual, harga_jual').gt('terjual', 0);
            if(errFetch) throw errFetch;
            const fInput = prompt("Masukkan total Uang Fisik (IDR):", "0");
            if(fInput === null) return;
            const f = parseInt(fInput) || 0;
            const { error: errInsert } = await client.from('laporan_harian').insert([{
                total_terjual_item: gItem,
                total_pendapatan_sistem: gTotal,
                uang_fisik_nyata: f,
                selisih: f - gTotal,
                detail_terjual: s
            }]);
            if(errInsert) throw errInsert;
            const { error: errUpdate } = await client.from('vouchers').update({ terjual: 0 }).neq('id', 0);
            if(errUpdate) throw errUpdate;
            refresh();
            alert("Berhasil Tutup Hari!");
        } catch(e) { console.error(e); alert("Waduh gagal simpan cuy!"); }
    }

    async function openHistory() {
        const { data } = await client.from('laporan_harian').select('*').order('tanggal', { ascending: false });
        let h = '';
        if (data) data.forEach(x => {
            h += `<div class="hist-item" style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid var(--border); background: var(--bg); margin-bottom: 5px; border-radius: 12px;">
                    <div><small>${x.tanggal}</small><br><b>${x.total_pendapatan_sistem/1000}k</b></div>
                    <button class="btn-m btn-p" style="padding:5px 15px; font-size:12px; max-width: 100px;" onclick="showProof('${x.tanggal}')">üîç BUKTI</button>
                  </div>`;
        });
        document.getElementById('histContent').innerHTML = h || 'Kosong.';
        openModal('mHistory');
    }

    async function clearAllHistory() {
        if(!confirm("‚ö†Ô∏è PERINGATAN! Ini bakal hapus SEMUA riwayat laporan. Lu yakin mau bantai semua?")) return;
        if(!confirm("Beneran nih? Gak bakal bisa balik lagi loh!")) return;
        
        try {
            const { error } = await client.from('laporan_harian').delete().gt('id', 0);
            if(error) throw error;
            alert("Riwayat berhasil dibersihkan! Kita mulai dari nol lagi.");
            closeModal('mHistory');
            refresh();
        } catch(e) {
            console.error(e);
            alert("Gagal hapus riwayat cuy!");
        }
    }

    async function doMove() {
    const id = document.getElementById('selP').value; // Ngambil ID dari dropdown
    const q = parseInt(document.getElementById('qtyP').value);
    
    if(!id) return alert("Pilih vouchernya dulu bosqu!");
    if(!q || q <= 0) return alert("Jumlahnya diisi dong!");

    const { data: v } = await client.from('vouchers').select('stok_kamar, stok_etalase').eq('id', id).single();
    
    if(v && v.stok_kamar >= q) {
        await client.from('vouchers').update({ 
            stok_kamar: v.stok_kamar - q, 
            stok_etalase: v.stok_etalase + q, 
            is_ignored: false 
        }).eq('id', id);
        
        // Reset input setelah sukses
        document.getElementById('qtyP').value = '';
        document.getElementById('selP').value = '';
        refresh();
    } else {
        alert("Stok di Kamar gak cukup cuy!");
    }
}

async function doRestock() {
    const id = document.getElementById('selR').value; // Ngambil ID dari dropdown
    const q = parseInt(document.getElementById('qtyR').value);
    
    if(!id) return alert("Pilih vouchernya dulu bosqu!");
    if(!q || q <= 0) return alert("Jumlahnya diisi dong!");

    const { data: v } = await client.from('vouchers').select('stok_kamar').eq('id', id).single();
    
    if(v) {
        await client.from('vouchers').update({ 
            stok_kamar: v.stok_kamar + q, 
            is_ignored: false 
        }).eq('id', id);
        
        // Reset input setelah sukses
        document.getElementById('qtyR').value = '';
        document.getElementById('selR').value = '';
        refresh();
    }
}

async function panicRestock() { 
    // lte(0) = stok 0 atau kurang
    const { data } = await client.from('vouchers').select('*').lte('stok_etalase', 0).eq('is_ignored', false).order('id', { ascending: true }); 
    
    if (data && data.length > 0) { 
        seqData = data; 
        seqIdx = 0; 
        renderSeq(); 
        openModal('mSequential'); 
    } else { 
        alert("Stok masih aman semua, belum ada yang nol cuy!"); 
    } 
}


    async function panicRestock() { const { data } = await client.from('vouchers').select('*').lt('stok_etalase', 2).eq('is_ignored', false).order('id', { ascending: true }); if (data && data.length > 0) { seqData = data; seqIdx = 0; renderSeq(); openModal('mSequential'); } else { alert("Aman cuy!"); } }
    async function toggleMute(id, s) { await client.from('vouchers').update({ is_ignored: s }).eq( 'id', id); refresh(); }
    async function doMove() { const id = document.getElementById('idP').value; const q = parseInt(document.getElementById('qtyP').value); const { data: v } = await client.from('vouchers').select('stok_kamar, stok_etalase').eq('id', id).single(); if(v && v.stok_kamar >= q) { await client.from('vouchers').update({ stok_kamar: v.stok_kamar - q, stok_etalase: v.stok_etalase + q, is_ignored: false }).eq('id', id); refresh(); } }
    async function doRestock() { const id = document.getElementById('idR').value; const q = parseInt(document.getElementById('qtyR').value); const { data: v } = await client.from('vouchers').select('stok_kamar').eq('id', id).single(); if(v) { await client.from('vouchers').update({ stok_kamar: v.stok_kamar + q, is_ignored: false }).eq('id', id); refresh(); } }
    async function loadChart() { const { data } = await client.from('laporan_harian').select('tanggal, total_pendapatan_sistem').order('tanggal', { ascending: true }).limit(10); if(!data) return; if(myChart) myChart.destroy(); const ctx = document.getElementById('fullChart').getContext('2d'); myChart = new Chart(ctx, { type: 'line', data: { labels: data.map(h => h.tanggal.split('-').slice(1).join('/')), datasets: [{ label: 'Cuan (IDR)', data: data.map(h => h.total_pendapatan_sistem), borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', borderWidth: 4, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } }); }
    function copyClose() { const t = document.getElementById('repRes'); t.select(); navigator.clipboard.writeText(t.value); closeModal('mView'); alert("Copy Berhasil!"); }
    function saveNew() { const p = { nama_lengkap: document.getElementById('aL').value, nama_wa: document.getElementById('aW').value, harga_jual: parseInt(document.getElementById('aH').value), stok_kamar: 0, stok_etalase: 0 }; client.from('vouchers').insert([p]).then(() => { closeModal('mAdd'); refresh(); }); }
    function toggleTheme() { const h = document.documentElement; const nxt = h.getAttribute('data-theme') === 'light' ? 'dark' : 'light'; h.setAttribute('data-theme', nxt); document.getElementById('themeIcon').innerText = nxt === 'light' ? 'üåû' : 'üåú'; localStorage.setItem('theme', nxt); }
    
    if(localStorage.getItem('theme')) document.documentElement.setAttribute('data-theme', localStorage.getItem('theme'));
    toggleResetUI();
</script>
</body>
</html>
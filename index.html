<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <title>VMS Pro - Mobile Master</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --card-rgb: 255, 255, 255;
            --text: #0f172a; --muted: #64748b; --border: #e2e8f0;
            --primary: #2563eb; --success: #10b981; --danger: #ef4444;
            --info: #0ea5e9; --logo: #334155; --overlay: rgba(15, 23, 42, 0.4);
        }
        [data-theme="dark"] {
            --bg: #020617; --card: #1e293b; --card-rgb: 30, 41, 59;
            --text: #f1f5f9; --muted: #94a3b8; --border: #334155;
            --primary: #3b82f6; --success: #10b981; --danger: #f87171;
            --info: #0ea5e9; --logo: #cbd5e1; --overlay: rgba(0, 0, 0, 0.7);
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounceIn { from { transform: scale(0.9); opacity: 0; } 70% { transform: scale(1.05); } to { transform: scale(1); opacity: 1; } }
        @keyframes slideInDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* STICKY HEADER GLASS WITH BLUR */
        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(var(--card-rgb), 0.75);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border); padding: 10px 15px;
            animation: slideInDown 0.5s ease-out;
        }
        .header-content { max-width: 1200px; margin: auto; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .main-actions { display: flex; gap: 6px; flex-grow: 1; }
        .btn-top { padding: 8px 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: white; font-size: 11px; flex: 1; transition: 0.2s; }
        .btn-top:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-wa { background: #25D366; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.2); } .btn-add { background: var(--muted); } .btn-res { background: var(--danger); }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 12px; }

        /* CARDS WITH FADE UP */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { 
            background: var(--card); padding: 18px; border-radius: 20px; border: 1px solid var(--border); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            animation: fadeUp 0.6s ease-out backwards;
        }
        .card h3 { font-size: 11px; margin: 0 0 15px 0; color: var(--muted); text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        label { display: block; font-size: 10px; font-weight: 700; color: var(--muted); margin-bottom: 4px; }
        input, select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 10px; box-sizing: border-box; font-size: 13px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        button.action { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; }
        button.action:active { transform: scale(0.97); }
        .btn-p { background: var(--primary); } 
        .btn-i { background: var(--info); } /* FIX: Sekarang tombol pindah punya shape! */
        .btn-s { background: var(--success); }

        /* TABLE SECTION */
        .table-box { background: var(--card); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; animation: fadeUp 0.8s ease-out 0.4s backwards; }
        .table-scroll { overflow-x: auto; width: 100%; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: rgba(var(--card-rgb), 0.5); padding: 15px; font-size: 10px; color: var(--muted); text-transform: uppercase; text-align: center; }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 13px; text-align: center; font-weight: 600; }
        tr:hover { background: rgba(var(--primary), 0.03); }
        .badge { background: rgba(239, 68, 68, 0.1); color: var(--danger); padding: 4px 10px; border-radius: 8px; }

        /* MODALS JAVA STYLE PERSIS */
        .modal-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: var(--overlay); 
            display:none; justify-content:center; align-items:center; z-index:2000; 
            backdrop-filter: blur(8px); padding: 20px; box-sizing: border-box;
        }
        .modal { 
            background: var(--card); padding: 30px; border-radius: 28px; width: 100%; max-width: 400px; 
            border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            animation: bounceIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal h2 { margin-top: 0; font-size: 20px; text-align: center; font-weight: 800; margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; margin-top: 25px; }
        .btn-m { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-content">
        <div class="brand">
            <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,7V13H13V7H11M11,15V17H13V15H11Z"/></svg>
        </div>
        <div class="main-actions">
            <button class="btn-top btn-wa" onclick="openLaporan()">üöÄ LAPORAN</button>
            <button class="btn-top btn-add" onclick="openModal('mAdd')">+ BARU</button>
            <button class="btn-top btn-res" onclick="openModal('mReset')">‚öôÔ∏è RESET</button>
        </div>
        <button onclick="toggleTheme()" id="themeIcon" style="background:none; border:none; cursor:pointer; font-size:18px; padding: 0 5px;">üåû</button>
    </div>
</div>

<div class="container">
    <div class="grid">
        <div class="card" style="animation-delay: 0.1s;">
            <h3>üìä Update Penjualan</h3>
            <div class="input-row">
                <div><label>ID</label><input type="number" id="idC"></div>
                <div><label>SISA</label><input type="number" id="sisC"></div>
            </div>
            <button class="action btn-p" onclick="doCek()">Update Stok</button>
        </div>
        <div class="card" style="animation-delay: 0.2s;">
            <h3>üöö Pindah Barang</h3>
            <div class="input-row">
                <div><label>ID</label><input type="number" id="idP"></div>
                <div><label>QTY</label><input type="number" id="qtyP"></div>
            </div>
            <button class="action btn-i" onclick="doMove()">Pindahkan</button>
        </div>
        <div class="card" style="animation-delay: 0.3s;">
            <h3>üì¶ Restock</h3>
            <div class="input-row">
                <div><label>ID</label><input type="number" id="idR"></div>
                <div><label>BELI</label><input type="number" id="qtyR"></div>
            </div>
            <button class="action btn-s" onclick="doRestock()">Simpan Stok</button>
        </div>
    </div>

    <div class="table-box">
        <div class="table-scroll">
            <table id="vTable">
                <thead><tr><th>ID</th><th>Voucher (Excel)</th><th>Harga</th><th>Kmr</th><th>Etl</th><th>Laku</th><th>Tot</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mAdd"><div class="modal"><h2>Voucher Baru</h2><div style="margin-bottom:12px"><label>Nama Lengkap (Excel):</label><input type="text" id="aL" placeholder="V AXIS 3.5GB/5HARI"></div><div style="margin-bottom:12px"><label>Nama WA (Singkat):</label><input type="text" id="aW" placeholder="axis 14"></div><div style="margin-bottom:12px"><label>Harga Jual:</label><input type="number" id="aH" placeholder="14000"></div><div class="input-row"><div><label>Stok Kamar:</label><input type="number" id="aK" value="0"></div><div><label>Stok Etalase:</label><input type="number" id="aE" value="0"></div></div><div class="modal-footer"><button class="btn-m btn-cancel" style="background:var(--bg); color:var(--text); border:1px solid var(--border);" onclick="closeModal('mAdd')">Batal</button><button class="btn-m btn-confirm" style="background:var(--primary); color:white" onclick="saveNew()">Simpan</button></div></div></div>

<div class="modal-overlay" id="mReset"><div class="modal"><h2>Reset Data</h2><label>Mode</label><select id="rScope" onchange="document.getElementById('rIDBox').style.display=this.value=='one'?'block':'none'" style="margin-bottom:12px"><option value="all">Semua</option><option value="one">Satu ID</option></select><div id="rIDBox" style="display:none; margin-bottom:12px;"><label>ID</label><input type="number" id="rID"></div><label>Kolom</label><select id="rCol"><option value="terjual">Terjual</option><option value="stok_etalase">Etalase</option><option value="stok_kamar">Kamar</option></select><div class="modal-footer"><button class="btn-m btn-cancel" style="background:var(--bg); color:var(--text); border:1px solid var(--border);" onclick="closeModal('mReset')">Batal</button><button class="btn-m btn-confirm" style="background:var(--danger); color:white" onclick="confirmReset()">Reset</button></div></div></div>

<div class="modal-overlay" id="mReport"><div class="modal"><h2>Laporan WA</h2><p id="tSis" style="font-weight:800; color:var(--primary); margin-bottom:15px; text-align:center;">Sistem: Rp0</p><label>Input Fisik</label><input type="number" id="iF"><div class="modal-footer"><button class="btn-m btn-cancel" style="background:var(--bg); color:var(--text); border:1px solid var(--border);" onclick="closeModal('mReport')">Batal</button><button class="btn-m btn-confirm" style="background:var(--primary); color:white" onclick="genFinal()">Generate</button></div></div></div>

<div class="modal-overlay" id="mView"><div class="modal"><h2>Salin Laporan</h2><textarea id="repRes" readonly style="width:100%; height:150px; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px; font-size:12px; outline:none; font-family:monospace;"></textarea><div class="modal-footer"><button class="btn-m btn-confirm" style="background:var(--success); color:white" onclick="copyClose()">Copy & Tutup</button></div></div></div>

<script>
    const SB_URL = "https://cphgjbsdzslyyaduherc.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwaGdqYnNkenNseXlhZHVoZXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDg4MDMsImV4cCI6MjA4NTg4NDgwM30.bzoog6sHewP_VpqCg7oXS33HyeB_OYEExB5cbsAnQX8";
    const client = supabase.createClient(SB_URL, SB_KEY);

    function toggleTheme() {
        const h = document.documentElement;
        const nxt = h.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        h.setAttribute('data-theme', nxt);
        document.getElementById('themeIcon').innerText = nxt === 'light' ? 'üåû' : 'üåú';
        localStorage.setItem('theme', nxt);
    }
    if(localStorage.getItem('theme')) document.documentElement.setAttribute('data-theme', localStorage.getItem('theme'));

    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }

    async function refresh() {
        const { data } = await client.from('vouchers').select('*').order('id', { ascending: true });
        const b = document.querySelector('#vTable tbody'); b.innerHTML = '';
        if (data) data.forEach((v, idx) => {
            const row = document.createElement('tr');
            row.style.animation = `fadeUp 0.5s ease-out ${0.05 * idx}s backwards`;
            row.innerHTML = `<td>#${v.id}</td><td style="text-align:left">${v.nama_lengkap}</td><td>${(v.harga_jual/1000)}k</td><td>${v.stok_kamar}</td><td>${v.stok_etalase}</td><td><span class="badge">${v.terjual}</span></td><td style="color:var(--primary)">${v.stok_kamar+v.stok_etalase}</td>`;
            b.appendChild(row);
        });
    }

    async function doCek() {
        const id = document.getElementById('idC').value;
        const s = parseInt(document.getElementById('sisC').value);
        const { data } = await client.from('vouchers').select('stok_etalase, terjual').eq('id', id).single();
        if (data && (data.stok_etalase - s >= 0)) {
            await client.from('vouchers').update({ stok_etalase: s, terjual: data.terjual + (data.stok_etalase - s) }).eq('id', id);
            refresh();
        }
    }

    async function doMove() {
        const id = document.getElementById('idP').value;
        const q = parseInt(document.getElementById('qtyP').value);
        const { data } = await client.from('vouchers').select('stok_kamar, stok_etalase').eq('id', id).single();
        if (data && data.stok_kamar >= q) {
            await client.from('vouchers').update({ stok_kamar: data.stok_kamar - q, stok_etalase: data.stok_etalase + q }).eq('id', id);
            refresh();
        }
    }

    async function doRestock() {
        const id = document.getElementById('idR').value;
        const q = parseInt(document.getElementById('qtyR').value);
        const { data } = await client.from('vouchers').select('stok_kamar').eq('id', id).single();
        if (data) {
            await client.from('vouchers').update({ stok_kamar: data.stok_kamar + q }).eq('id', id);
            refresh();
        }
    }

    let gTotal = 0; let gRep = "";
    async function openLaporan() {
        const { data } = await client.from('vouchers').select('*').order('id', { ascending: true });
        gTotal = 0; gRep = "*LAPORAN STOK HARIAN*\n\n";
        data.forEach(v => { gRep += `‚Ä¢ ${v.nama_wa} = ${v.stok_etalase}\n`; gTotal += (v.terjual * v.harga_jual); });
        document.getElementById('tSis').innerText = `Total: Rp${gTotal.toLocaleString()}`;
        openModal('mReport');
    }

    function genFinal() {
        const f = parseInt(document.getElementById('iF').value) || 0;
        const final = gRep + `\n------------------\nüí∞ Target: Rp${gTotal.toLocaleString()}\nüíµ Fisik: Rp${f.toLocaleString()}\nüö® Mama: Rp${(gTotal - f).toLocaleString()}`;
        document.getElementById('repRes').value = final;
        closeModal('mReport'); openModal('mView');
    }

    function copyClose() {
        const t = document.getElementById('repRes'); t.select();
        navigator.clipboard.writeText(t.value); closeModal('mView');
    }

    async function saveNew() {
        const nL = document.getElementById('aL').value; const nW = document.getElementById('aW').value;
        const h = parseInt(document.getElementById('aH').value); const k = parseInt(document.getElementById('aK').value);
        const e = parseInt(document.getElementById('aE').value);
        if(nL && nW && h) {
            await client.from('vouchers').insert([{ nama_lengkap: nL, nama_wa: nW, harga_jual: h, stok_kamar: k, stok_etalase: e }]);
            closeModal('mAdd'); refresh();
        }
    }

    async function confirmReset() {
        const col = document.getElementById('rCol').value;
        if(document.getElementById('rScope').value === 'all') await client.from('vouchers').update({ [col]: 0 }).neq('id', 0);
        else await client.from('vouchers').update({ [col]: 0 }).eq('id', document.getElementById('rID').value);
        closeModal('mReset'); refresh();
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                console.log('VMS App Ready!', reg.scope);
            }).catch(err => {
                console.log('SW failed: ', err);
            });
        });
    }
    
    refresh();
</script>
</body>
</html>
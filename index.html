<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voucher Management System Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
            --border: #e2e8f0; --primary: #2563eb; --success: #10b981;
            --danger: #ef4444; --info: #0ea5e9; --logo: #1e293b;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] {
            --bg: #020617; --card: #1e293b; --text: #f1f5f9; --muted: #94a3b8;
            --border: #334155; --logo: #f1f5f9; --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }

        /* HEADER & LOGO */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand svg { width: 35px; height: 35px; fill: var(--logo); }
        .brand h1 { font-size: 22px; margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        .theme-toggle { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 12px; cursor: pointer; color: var(--text); font-size: 18px; }

        /* DASHBOARD GRID */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card h3 { font-size: 15px; margin-top: 0; margin-bottom: 20px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 6px; }
        input, select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 10px; box-sizing: border-box; font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary); }

        button.action { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; color: white; font-size: 14px; }
        .btn-p { background: var(--primary); } .btn-i { background: var(--info); } .btn-s { background: var(--success); }
        button:active { transform: scale(0.98); }

        /* TABLE SECTION */
        .table-box { background: var(--card); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg); padding: 15px; font-size: 12px; color: var(--muted); text-transform: uppercase; text-align: center; }
        td { padding: 16px; border-bottom: 1px solid var(--border); font-size: 14px; text-align: center; }
        .badge { background: rgba(239, 68, 68, 0.1); color: var(--danger); padding: 4px 10px; border-radius: 8px; font-weight: 700; }

        /* CUSTOM MODAL SYSTEM (JAVA STYLE) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--card); padding: 30px; border-radius: 24px; width: 90%; max-width: 450px; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; }
        .modal-content h2 { margin-top: 0; font-size: 20px; margin-bottom: 10px; }
        .modal-content p { color: var(--muted); font-size: 14px; margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
        .btn-cancel { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-confirm { background: var(--primary); color: white; }

        /* FOOTER */
        .footer { margin-top: 40px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding-bottom: 40px; }
        .btn-wa { background: #25D366; width: 340px; }
        .btn-res { background: var(--danger); width: 180px; }
        .btn-seed { background: #8b5cf6; width: 180px; }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <div class="brand">
            <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
            <h1>Voucher Systems Pro</h1>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeIcon">üåû</button>
    </header>

    <div class="grid">
        <div class="card">
            <h3>üìä Update Penjualan</h3>
            <div class="input-row">
                <div><label>ID VOUCHER</label><input type="number" id="idC"></div>
                <div><label>SISA ETALASE</label><input type="number" id="sisC"></div>
            </div>
            <button class="action btn-p" onclick="doCek()">Update Stok</button>
        </div>
        <div class="card">
            <h3>üöö Pindah Barang</h3>
            <div class="input-row">
                <div><label>ID VOUCHER</label><input type="number" id="idP"></div>
                <div><label>QTY PINDAH</label><input type="number" id="qtyP"></div>
            </div>
            <button class="action btn-i" onclick="doMove()">Eksekusi Pindah</button>
        </div>
        <div class="card">
            <h3>üì¶ Restock Kamar</h3>
            <div class="input-row">
                <div><label>ID VOUCHER</label><input type="number" id="idR"></div>
                <div><label>JUMLAH BELI</label><input type="number" id="qtyR"></div>
            </div>
            <button class="action btn-s" onclick="doRestock()">Simpan ke Kamar</button>
        </div>
    </div>

    <div class="table-box">
        <table id="vTable">
            <thead>
                <tr><th>ID</th><th>Nama Voucher</th><th>Harga</th><th>Kamar</th><th>Etalase</th><th>Laku</th><th>Total</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="footer">
        <button class="action btn-wa" onclick="getWA()">üöÄ GENERATE & COPY LAPORAN WA</button>
        <button class="action btn-res" onclick="openResetModal()">‚öôÔ∏è Menu Reset</button>
        <button class="action btn-seed" onclick="openSeedModal()">‚ö° Auto-Seed Excel</button>
    </div>
</div>

<div class="modal-overlay" id="modalReset">
    <div class="modal-content">
        <h2>Menu Reset Data</h2>
        <p>Pilih tipe reset dan kolom yang ingin dinolin.</p>
        <label>Tipe Reset</label>
        <select id="resetType" onchange="toggleResetID()">
            <option value="all">Semua Baris</option>
            <option value="single">Satu Baris (Pake ID)</option>
        </select>
        <div id="idResetBox" style="display:none; margin-top:15px;">
            <label>Masukkan ID Voucher</label>
            <input type="number" id="resetIDInput" placeholder="Contoh: 1">
        </div>
        <div style="margin-top:15px;">
            <label>Pilih Kolom</label>
            <select id="resetCol">
                <option value="terjual">Kolom Terjual</option>
                <option value="stok_etalase">Kolom Etalase</option>
                <option value="stok_kamar">Kolom Kamar (Modal)</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn-modal btn-cancel" onclick="closeModal('modalReset')">Batal</button>
            <button class="btn-modal btn-confirm" onclick="doReset()">Reset Sekarang</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalReport">
    <div class="modal-content">
        <h2 id="repTitle">Laporan Penjualan</h2>
        <textarea id="repText" style="width:100%; height:200px; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px; font-family:monospace; font-size:12px;"></textarea>
        <div class="modal-footer">
            <button class="btn-modal btn-confirm" onclick="copyAndClose()">Copy & Tutup</button>
        </div>
    </div>
</div>

<script>
    // --- KREDENSIAL SUPABASE ---
    const SB_URL = "https://cphgjbsdzslyyaduherc.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwaGdqYnNkenNseXlhZHVoZXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDg4MDMsImV4cCI6MjA4NTg4NDgwM30.bzoog6sHewP_VpqCg7oXS33HyeB_OYEExB5cbsAnQX8";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    // 1. TEMA LOGIC
    function toggleTheme() {
        const h = document.documentElement;
        const cur = h.getAttribute('data-theme');
        const nxt = cur === 'light' ? 'dark' : 'light';
        h.setAttribute('data-theme', nxt);
        document.getElementById('themeIcon').innerText = nxt === 'light' ? 'üåû' : 'üåú';
        localStorage.setItem('theme', nxt);
    }
    // Load theme saved
    if(localStorage.getItem('theme')) document.documentElement.setAttribute('data-theme', localStorage.getItem('theme'));

    // 2. MODAL CONTROLS
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function toggleResetID() {
        const type = document.getElementById('resetType').value;
        document.getElementById('idResetBox').style.display = type === 'single' ? 'block' : 'none';
    }

    // 3. CORE LOGIC
    async function refresh() {
        const { data, error } = await supabaseClient.from('vouchers').select('*').order('id', { ascending: true });
        if (error) return;
        const b = document.querySelector('#vTable tbody'); b.innerHTML = '';
        data.forEach(v => {
            b.innerHTML += `<tr><td>#${v.id}</td><td style="text-align:left; font-weight:700">${v.nama_wa}</td><td>Rp${v.harga_jual.toLocaleString()}</td><td>${v.stok_kamar}</td><td>${v.stok_etalase}</td><td><span class="badge">${v.terjual}</span></td><td style="font-weight:700; color:var(--primary)">${v.stok_kamar + v.stok_etalase}</td></tr>`;
        });
    }

    async function doCek() {
        const id = document.getElementById('idC').value;
        const s = parseInt(document.getElementById('sisC').value);
        const { data } = await supabaseClient.from('vouchers').select('stok_etalase, terjual').eq('id', id).single();
        if (data && (data.stok_etalase - s >= 0)) {
            await supabaseClient.from('vouchers').update({ stok_etalase: s, terjual: data.terjual + (data.stok_etalase - s) }).eq('id', id);
            refresh(); showToast("Stok Terupdate!");
        } else alert("Cek ID/Sisa!");
    }

    async function doMove() {
        const id = document.getElementById('idP').value;
        const q = parseInt(document.getElementById('qtyP').value);
        const { data } = await supabaseClient.from('vouchers').select('stok_kamar, stok_etalase').eq('id', id).single();
        if (data && data.stok_kamar >= q) {
            await supabaseClient.from('vouchers').update({ stok_kamar: data.stok_kamar - q, stok_etalase: data.stok_etalase + q }).eq('id', id);
            refresh(); showToast("Pindah Berhasil!");
        }
    }

    async function doRestock() {
        const id = document.getElementById('idR').value;
        const q = parseInt(document.getElementById('qtyR').value);
        const { data } = await supabaseClient.from('vouchers').select('stok_kamar').eq('id', id).single();
        if (data) {
            await supabaseClient.from('vouchers').update({ stok_kamar: data.stok_kamar + q }).eq('id', id);
            refresh(); showToast("Restock Berhasil!");
        }
    }

    async function getWA() {
        const { data } = await supabaseClient.from('vouchers').select('*');
        let total = 0; let rep = "*LAPORAN STOK HARIAN*\n\n";
        data.forEach(v => { rep += `‚Ä¢ ${v.nama_wa} = sisa *${v.stok_etalase}*\n`; total += (v.terjual * v.harga_jual); });
        
        const f = prompt(`Sistem: Rp${total.toLocaleString()}\nMasukkan Uang Fisik:`);
        if (f !== null) {
            const m = total - parseInt(f.replace(/\D/g,'') || 0);
            rep += `\n------------------\nüí∞ *Total:* Rp${total.toLocaleString()}\nüíµ *Fisik:* Rp${parseInt(f).toLocaleString()}\nüö® *Mama:* Rp${m.toLocaleString()}`;
            document.getElementById('repText').value = rep;
            openModal('modalReport');
        }
    }

    function openResetModal() { openModal('modalReset'); }

    async function doReset() {
        const type = document.getElementById('resetType').value;
        const col = document.getElementById('resetCol').value;
        if (type === 'all') {
            if(confirm("Yakin reset SEMUA baris?")) await supabaseClient.from('vouchers').update({ [col]: 0 }).neq('id', 0);
        } else {
            const id = document.getElementById('resetIDInput').value;
            await supabaseClient.from('vouchers').update({ [col]: 0 }).eq('id', id);
        }
        closeModal('modalReset'); refresh();
    }

    function copyAndClose() {
        const t = document.getElementById('repText');
        t.select(); navigator.clipboard.writeText(t.value);
        closeModal('modalReport'); showToast("Laporan dicopy!");
    }

    function showToast(m) { alert(m); } // Bisa diganti toast beneran nanti

    function openSeedModal() { if(confirm("Isi data awal?")) seedNow(); }
    async function seedNow() {
        const d = [
            {nama_wa: "indosat 15", harga_jual: 15000}, {nama_wa: "axis 14", harga_jual: 14000, stok_kamar: 11, stok_etalase: 4},
            {nama_wa: "axis 18", harga_jual: 18000, stok_kamar: 5, stok_etalase: 3}, {nama_wa: "axis 30", harga_jual: 30000, stok_kamar: 2, stok_etalase: 1},
            {nama_wa: "axis 50", harga_jual: 50000, stok_etalase: 1}, {nama_wa: "XL 15", harga_jual: 15000, stok_kamar: 3, stok_etalase: 5},
            {nama_wa: "XL 50", harga_jual: 50000, stok_kamar: 2, stok_etalase: 1}, {nama_wa: "XL 70", harga_jual: 70000, stok_etalase: 1},
            {nama_wa: "Tri 14", harga_jual: 14000, stok_kamar: 3, stok_etalase: 3}, {nama_wa: "Tri 18", harga_jual: 18000},
            {nama_wa: "Smart 8", harga_jual: 8000, stok_etalase: 2}, {nama_wa: "Smart 14", harga_jual: 14000, stok_etalase: 2},
            {nama_wa: "Smart 30", harga_jual: 30000, stok_kamar: 1, stok_etalase: 1}, {nama_wa: "Smart 77", harga_jual: 77000, stok_kamar: 1, stok_etalase: 1},
            {nama_wa: "Smart 95", harga_jual: 95000, stok_kamar: 1, stok_etalase: 1}, {nama_wa: "Telkom 10", harga_jual: 10000, stok_etalase: 2},
            {nama_wa: "Telkom 13", harga_jual: 13000, stok_etalase: 3}, {nama_wa: "Telkom 20", harga_jual: 20000}
        ];
        await supabaseClient.from('vouchers').insert(d); refresh();
    }

    refresh();
</script>
</body>
</html>
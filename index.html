<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voucher Management System Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
            --border: #e2e8f0; --primary: #2563eb; --success: #10b981;
            --danger: #ef4444; --info: #0ea5e9; --logo: #334155; /* Logo Abu Tua */
            --overlay: rgba(0,0,0,0.4);
        }
        [data-theme="dark"] {
            --bg: #020617; --card: #1e293b; --text: #f1f5f9; --muted: #94a3b8;
            --border: #334155; --logo: #e2e8f0; --overlay: rgba(0,0,0,0.7);
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* HEADER & LOGO */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand svg { width: 32px; height: 32px; fill: var(--logo); }
        .brand h1 { font-size: 24px; margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        .theme-btn { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 12px; cursor: pointer; color: var(--text); }

        /* DASHBOARD GRID */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card h3 { font-size: 14px; margin: 0 0 15px 0; color: var(--muted); text-transform: uppercase; font-weight: 700; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 5px; }
        input, select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 10px; box-sizing: border-box; font-size: 14px; }

        /* BUTTONS */
        button.action { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; }
        .btn-p { background: var(--primary); } .btn-i { background: var(--info); } .btn-s { background: var(--success); }
        button:active { transform: scale(0.97); }

        /* TABLE */
        .table-box { background: var(--card); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg); padding: 15px; font-size: 12px; color: var(--muted); text-transform: uppercase; text-align: center; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; text-align: center; font-weight: 500; }
        .badge { background: rgba(239, 68, 68, 0.1); color: var(--danger); padding: 4px 10px; border-radius: 8px; font-weight: 700; }

        /* JAVA-STYLE MODALS */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--overlay); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(4px); }
        .modal { background: var(--card); padding: 30px; border-radius: 24px; width: 90%; max-width: 450px; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal h2 { margin-top: 0; font-size: 20px; }
        .modal-footer { display: flex; gap: 10px; margin-top: 25px; }
        .btn-m { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
        .btn-cancel { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-confirm { background: var(--primary); color: white; }

        /* FOOTER ACTIONS */
        .footer { margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; padding-bottom: 50px; }
        .btn-wa { background: #25D366; width: 350px; font-size: 15px; }
        .btn-res { background: var(--danger); width: 160px; }
        .btn-add { background: var(--muted); width: 160px; }
        .btn-seed { background: #8b5cf6; width: 160px; }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <div class="brand">
            <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
            <h1>Voucher Systems Pro</h1>
        </div>
        <button class="theme-btn" onclick="toggleTheme()" id="themeIcon">üåû</button>
    </header>

    <div class="grid">
        <div class="card">
            <h3>üìä Update Penjualan</h3>
            <div class="input-row">
                <div><label>ID VOUCHER</label><input type="number" id="idC"></div>
                <div><label>SISA ETALASE</label><input type="number" id="sisC"></div>
            </div>
            <button class="action btn-p" onclick="doCek()">Hitung Terjual</button>
        </div>
        <div class="card">
            <h3>üöö Pindah Barang</h3>
            <div class="input-row">
                <div><label>ID VOUCHER</label><input type="number" id="idP"></div>
                <div><label>QTY PINDAH</label><input type="number" id="qtyP"></div>
            </div>
            <button class="action btn-i" onclick="doMove()">Pindahkan</button>
        </div>
        <div class="card">
            <h3>üì¶ Restock Kamar</h3>
            <div class="input-row">
                <div><label>ID VOUCHER</label><input type="number" id="idR"></div>
                <div><label>JUMLAH BELI</label><input type="number" id="qtyR"></div>
            </div>
            <button class="action btn-s" onclick="doRestock()">Simpan Stok</button>
        </div>
    </div>

    <div class="table-box">
        <table id="vTable">
            <thead>
                <tr><th>ID</th><th>Nama Voucher</th><th>Harga</th><th>Kamar</th><th>Etalase</th><th>Laku</th><th>Total</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="footer">
        <button class="action btn-wa" onclick="openLaporan()">üöÄ GENERATE & COPY LAPORAN WA</button>
        <button class="action btn-add" onclick="openAddModal()">+ Tambah Baru</button>
        <button class="action btn-res" onclick="openResetModal()">‚öôÔ∏è Menu Reset</button>
        <button class="action btn-seed" onclick="doSeed()">‚ö° Auto-Seed Excel</button>
    </div>
</div>

<div class="modal-overlay" id="modalAdd">
    <div class="modal">
        <h2>Tambah Voucher Baru</h2>
        <div style="margin-bottom:15px"><label>Nama Lengkap</label><input type="text" id="addNameL"></div>
        <div style="margin-bottom:15px"><label>Nama WA (Singkat)</label><input type="text" id="addNameW"></div>
        <div class="input-row">
            <div><label>Harga Jual</label><input type="number" id="addPrice"></div>
            <div><label>Stok Kamar</label><input type="number" id="addKamar" value="0"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-m btn-cancel" onclick="closeM('modalAdd')">Batal</button>
            <button class="btn-m btn-confirm" onclick="saveNew()">Simpan</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalReset">
    <div class="modal">
        <h2>Menu Reset Data</h2>
        <div style="margin-bottom:15px">
            <label>Jangkauan Reset</label>
            <select id="resScope" onchange="document.getElementById('resIDBox').style.display = this.value=='one'?'block':'none'">
                <option value="all">Semua Baris</option>
                <option value="one">Satu Baris (Pake ID)</option>
            </select>
        </div>
        <div id="resIDBox" style="display:none; margin-bottom:15px;"><label>Masukkan ID</label><input type="number" id="resID"></div>
        <div style="margin-bottom:15px">
            <label>Pilih Kolom yang Dinolin</label>
            <select id="resCol">
                <option value="terjual">Kolom Terjual</option>
                <option value="stok_etalase">Kolom Etalase</option>
                <option value="stok_kamar">Kolom Kamar (Modal)</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn-m btn-cancel" onclick="closeM('modalReset')">Batal</button>
            <button class="btn-m btn-confirm" style="background:var(--danger)" onclick="confirmReset()">Reset Sekarang</button>
        </div>
    </div>
</div>

<script>
    // --- KREDENSIAL SUPABASE LO ---
    const SB_URL = "https://cphgjbsdzslyyaduherc.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwaGdqYnNkenNseXlhZHVoZXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDg4MDMsImV4cCI6MjA4NTg4NDgwM30.bzoog6sHewP_VpqCg7oXS33HyeB_OYEExB5cbsAnQX8";
    const client = supabase.createClient(SB_URL, SB_KEY);

    // TEMA LOGIC
    function toggleTheme() {
        const h = document.documentElement;
        const nxt = h.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        h.setAttribute('data-theme', nxt);
        document.getElementById('themeIcon').innerText = nxt === 'light' ? 'üåû' : 'üåú';
        localStorage.setItem('vms-theme', nxt);
    }
    if(localStorage.getItem('vms-theme')) document.documentElement.setAttribute('data-theme', localStorage.getItem('vms-theme'));

    // MODAL UTILS
    function openM(id) { document.getElementById(id).style.display = 'flex'; }
    function closeM(id) { document.getElementById(id).style.display = 'none'; }

    // REFRESH TABLE
    async function refresh() {
        const { data, error } = await client.from('vouchers').select('*').order('id', { ascending: true });
        if (error) return console.error(error);
        const b = document.querySelector('#vTable tbody'); b.innerHTML = '';
        data.forEach(v => {
            b.innerHTML += `<tr><td>#${v.id}</td><td style="text-align:left; font-weight:700">${v.nama_wa}</td><td>Rp${v.harga_jual.toLocaleString()}</td><td>${v.stok_kamar}</td><td>${v.stok_etalase}</td><td><span class="badge">${v.terjual}</span></td><td style="color:var(--primary); font-weight:700">${v.stok_kamar + v.stok_etalase}</td></tr>`;
        });
    }

    // CORE ACTIONS
    async function doCek() {
        const id = document.getElementById('idC').value;
        const s = parseInt(document.getElementById('sisC').value);
        const { data } = await client.from('vouchers').select('stok_etalase, terjual').eq('id', id).single();
        if (data && (data.stok_etalase - s >= 0)) {
            await client.from('vouchers').update({ stok_etalase: s, terjual: data.terjual + (data.stok_etalase - s) }).eq('id', id);
            refresh(); alert("Stok Terupdate!");
        } else alert("Input ID/Sisa Salah!");
    }

    async function doMove() {
        const id = document.getElementById('idP').value;
        const q = parseInt(document.getElementById('qtyP').value);
        const { data } = await client.from('vouchers').select('stok_kamar, stok_etalase').eq('id', id).single();
        if (data && data.stok_kamar >= q) {
            await client.from('vouchers').update({ stok_kamar: data.stok_kamar - q, stok_etalase: data.stok_etalase + q }).eq('id', id);
            refresh(); alert("Berhasil Pindah!");
        } else alert("Stok Kamar Gak Cukup!");
    }

    async function doRestock() {
        const id = document.getElementById('idR').value;
        const q = parseInt(document.getElementById('qtyR').value);
        const { data } = await client.from('vouchers').select('stok_kamar').eq('id', id).single();
        if (data) {
            await client.from('vouchers').update({ stok_kamar: data.stok_kamar + q }).eq('id', id);
            refresh(); alert("Restock Berhasil!");
        }
    }

    // LAPORAN WA
    async function openLaporan() {
        const { data } = await client.from('vouchers').select('*');
        let total = 0; let rep = "*LAPORAN STOK HARIAN*\n\n";
        data.forEach(v => { rep += `‚Ä¢ ${v.nama_wa} = sisa *${v.stok_etalase}*\n`; total += (v.terjual * v.harga_jual); });
        const f = prompt(`Sistem: Rp${total.toLocaleString()}\nInput Duit Fisik:`);
        if (f !== null) {
            const m = total - parseInt(f.replace(/\D/g,'') || 0);
            rep += `\n------------------\nüí∞ *Total:* Rp${total.toLocaleString()}\nüíµ *Fisik:* Rp${parseInt(f).toLocaleString()}\nüö® *Mama:* Rp${m.toLocaleString()}`;
            navigator.clipboard.writeText(rep); alert("Laporan dicopy ke clipboard!");
        }
    }

    // MODAL ACTIONS
    function openAddModal() { openM('modalAdd'); }
    async function saveNew() {
        const nL = document.getElementById('addNameL').value;
        const nW = document.getElementById('addNameW').value;
        const h = document.getElementById('addPrice').value;
        const k = document.getElementById('addKamar').value;
        await client.from('vouchers').insert([{ nama_lengkap: nL, nama_wa: nW, harga_jual: parseInt(h), stok_kamar: parseInt(k) }]);
        closeM('modalAdd'); refresh();
    }

    function openResetModal() { openM('modalReset'); }
    async function confirmReset() {
        const scope = document.getElementById('resScope').value;
        const col = document.getElementById('resCol').value;
        if (scope === 'all') {
            if(confirm("Nolin SEMUA baris di kolom "+col+"?")) await client.from('vouchers').update({ [col]: 0 }).neq('id', 0);
        } else {
            const id = document.getElementById('resID').value;
            await client.from('vouchers').update({ [col]: 0 }).eq('id', id);
        }
        closeM('modalReset'); refresh();
    }

    // SEEDING MASSAL
    async function doSeed() {
        if(!confirm("Isi 20 data awal Excel?")) return;
        const d = [
            {nama_lengkap: "V INDOSAT 2.5GB/5HARI", nama_wa: "indosat 15", harga_jual: 15000},
            {nama_lengkap: "V AXIS 3.5GB/5HARI", nama_wa: "axis 14", harga_jual: 14000, stok_kamar: 11, stok_etalase: 4},
            {nama_lengkap: "V AXIS 4.5GB/5HARI", nama_wa: "axis 18", harga_jual: 18000, stok_kamar: 5, stok_etalase: 3},
            {nama_lengkap: "V AXIS 5GB/15HARI", nama_wa: "axis 30", harga_jual: 30000, stok_kamar: 2, stok_etalase: 1},
            {nama_lengkap: "V AXIS 8GB/15HARI", nama_wa: "axis 50", harga_jual: 50000, stok_etalase: 1},
            {nama_lengkap: "V XL 2GB/7HARI", nama_wa: "XL 15", harga_jual: 15000, stok_kamar: 3, stok_etalase: 5},
            {nama_lengkap: "V XL FLEX M", nama_wa: "XL 50", harga_jual: 50000, stok_kamar: 2, stok_etalase: 1},
            {nama_lengkap: "V XL FLEX L", nama_wa: "XL 70", harga_jual: 70000, stok_etalase: 1},
            {nama_lengkap: "V TRI 2GB/5HARI", nama_wa: "Tri 14", harga_jual: 14000, stok_kamar: 3, stok_etalase: 3},
            {nama_lengkap: "V TRI 3.5GB/5HARI", nama_wa: "Tri 18", harga_jual: 18000},
            {nama_lengkap: "V SMARTFREN 4GB/3HARI", nama_wa: "Smart 8", harga_jual: 8000, stok_etalase: 2},
            {nama_lengkap: "V SMARTFREN 6GB/7HARI", nama_wa: "Smart 14", harga_jual: 14000, stok_etalase: 2},
            {nama_lengkap: "V SMARTFREN UNL 7HARI", nama_wa: "Smart 30", harga_jual: 30000, stok_kamar: 1, stok_etalase: 1},
            {nama_lengkap: "V SMARTFREN UNL 1GB/28HARI", nama_wa: "Smart 77", harga_jual: 77000, stok_kamar: 1, stok_etalase: 1},
            {nama_lengkap: "V SMARTFREN UNL 2GB/28HARI", nama_wa: "Smart 95", harga_jual: 95000, stok_kamar: 1, stok_etalase: 1},
            {nama_lengkap: "V TELKOMSEL 1.5GB/3HARI", nama_wa: "Telkom 10", harga_jual: 10000, stok_etalase: 2},
            {nama_lengkap: "V TELKOMSEL 2.5GB/5HARI", nama_wa: "Telkom 13", harga_jual: 13000, stok_etalase: 3},
            {nama_lengkap: "V TELKOMSEL 3.5GB/7HARI", nama_wa: "Telkom 20", harga_jual: 20000}
        ];
        await client.from('vouchers').insert(d); refresh();
    }

    refresh();
</script>
</body>
</html>